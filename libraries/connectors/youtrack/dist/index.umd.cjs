(function(u,l){typeof exports=="object"&&typeof module<"u"?l(exports,require("axios")):typeof define=="function"&&define.amd?define(["exports","axios"],l):(u=typeof globalThis<"u"?globalThis:u||self,l(u["coya-youtrack-connector"]={},u.axios))})(this,function(u,l){"use strict";function ve(e){return e}const f=l.create({baseURL:"https://socialtech.myjetbrains.com/api/",headers:{Authorization:"Bearer <token>"}});var p=(e=>(e.Subtask="Subtask",e.Duplicate="Duplicate",e.Depend="Depend",e.Relates="Relates",e))(p||{});function I({issues:e,isAlreadyLoaded:t,addRelation:n}){const o=t??(i=>!1);return e.flatMap(i=>{const s=S(i);return s&&s.length>0?(s.forEach(a=>n({from:i.id,to:a,type:p.Subtask})),s.filter(a=>!o(a))):[]})}function S(e){return e.links.filter(t=>t.linkType.name===p.Subtask&&t.direction==="OUTWARD").flatMap(t=>t.issues).map(t=>t.id)}const T="customFields($type,name,value($type,archived,avatarUrl,buildIntegration,buildLink,color(background,id),description,fullName,id,isResolved,localizedName,login,markdownText,minutes,name,presentation,ringId,text))",g="id,login,name,fullName,avatarUrl,email",M=`reporter(${g})`,E=`updater(${g})`,h=`fields=id,idReadable,summary,description,updated,created,usesMarkdown,${M},${E},links(id,direction,linkType(name),issues(id)),tags(name),${T}`,D=`fields=text,id,created,updated,author(${g}),attachments(id,url,name)`;async function j(e){let t=e.ids;const{maxDepthLevel:n}=e;let o=0;for(;t.length>0&&(!n||o++<n);)t=await O({...e,ids:t})}async function O({ids:e,onLoadedIssue:t,isAlreadyLoaded:n,addRelation:o}){const i=(await f.post(`issuesGetter?${h}`,e.map(s=>({id:s})))).data;return i.forEach(s=>t(s)),I({issues:i,isAlreadyLoaded:n,addRelation:o})}function _(e){B(e),P(e),C(e),G(e),q(e),Q(e)}function B({issue:e,addNode:t,addRelation:n}){var o;(o=e.tags)==null||o.forEach(r=>{t("tag",{id:r.name,...r}),n({toNode:"tag",to:r.name,fromNode:"issue",from:e.id,type:"tag"})})}function P({issue:e,addNode:t,addRelation:n}){var i,s;const o=(s=(i=e.customFields)==null?void 0:i.find(a=>a.name==="GitLab PR link"))==null?void 0:s.value,r=o==null?void 0:o.matchAll(/merge_requests\/(?<mrNumber>\d*)/gm);r&&Array.from(r).map(c=>{var m;return((m=c.groups)==null?void 0:m.mrNumber)||""}).forEach(c=>{t("mr",{id:c,number:c}),n({toNode:"mr",to:c,fromNode:"issue",from:e.id,type:"mr"})})}function C({issue:e,addNode:t,addRelation:n}){var r,i;const o=(i=(r=e.customFields)==null?void 0:r.find(s=>s.name==="Assignee"))==null?void 0:i.value;o&&Array.isArray(o)&&o.forEach(s=>{t("trackerUser",{id:s.id,name:s.name,fullName:s.fullName,login:s.login,avatarUrl:s.avatarUrl,email:s.email}),n({fromNode:"issue",from:e.id,toNode:"trackerUser",to:s.id,type:"assignee"})})}function G({issue:e,addNode:t,addRelation:n}){var r,i;const o=(i=(r=e.customFields)==null?void 0:r.find(s=>s.name==="Assignee QA"))==null?void 0:i.value;o&&Array.isArray(o)&&o.forEach(s=>{t("trackerUser",{id:s.id,name:s.name,fullName:s.fullName,login:s.login,avatarUrl:s.avatarUrl,email:s.email}),n({fromNode:"issue",from:e.id,toNode:"trackerUser",to:s.id,type:"assigneeQA"})})}function q({issue:e,addNode:t,addRelation:n}){const o=e.reporter;o&&o.id&&(t("trackerUser",{id:o.id,name:o.name,fullName:o.fullName,login:o.login,avatarUrl:o.avatarUrl,email:o.email}),n({fromNode:"issue",from:e.id,toNode:"trackerUser",to:o.id,type:"reporter"}))}function Q({issue:e,addNode:t,addRelation:n}){const o=e.updater;o&&o.id&&(t("trackerUser",{id:o.id,name:o.name,fullName:o.fullName,login:o.login,avatarUrl:o.avatarUrl,email:o.email}),n({fromNode:"issue",from:e.id,toNode:"trackerUser",to:o.id,type:"updater"}))}function X(e){var t,n,o,r,i,s,a,c,m,w,R,U,$,L,v,x;return{storyPoints:(n=(t=e.customFields)==null?void 0:t.find(d=>d.name==="Story points"))==null?void 0:n.value,state:(i=(r=(o=e.customFields)==null?void 0:o.find(d=>d.name==="State"))==null?void 0:r.value)==null?void 0:i.name,source:(c=(a=(s=e.customFields)==null?void 0:s.find(d=>d.name==="Source"))==null?void 0:a.value)==null?void 0:c.name,priority:(R=(w=(m=e.customFields)==null?void 0:m.find(d=>d.name==="Priority"))==null?void 0:w.value)==null?void 0:R.name,severity:(L=($=(U=e.customFields)==null?void 0:U.find(d=>d.name==="Severity"))==null?void 0:$.value)==null?void 0:L.name,tags:(x=(v=e.tags)==null?void 0:v.map(d=>d.name))==null?void 0:x.join(",")}}function H(){const e=new Map,t=new Map,n=[],o=i=>n.push(i),r=(i,s)=>{t.has(i)||t.set(i,new Map);const a=t.get(i);a&&!a.has(s.id)&&a.set(s.id,s)};return{addNode:r,addRelation:o,isAlreadyLoaded(i){return e.has(i)},addIssue(i){if(!e.has(i.id)){const s={...i,links:void 0,tags:void 0,customFields:void 0,...X(i)};e.set(i.id,s),_({issue:i,addNode:r,addRelation:o})}},addIssueRelation({from:i,to:s,type:a}){return o({fromNode:"issue",from:i,toNode:"issue",to:s,type:a})},getIssues(){return N(e)},getRelations(){return n},getNodes(){return W(t)}}}function W(e){return Array.from(e).map(([t,n])=>[t,N(n)])}function N(e){return Array.from(e,([t,n])=>n)}var b=1/0,k=9007199254740991,Y=17976931348623157e292,A=0/0,J="[object Function]",K="[object GeneratorFunction]",V="[object Symbol]",Z=/^\s+|\s+$/g,z=/^[-+]0x[0-9a-f]+$/i,ee=/^0b[01]+$/i,te=/^0o[0-7]+$/i,ne=/^(?:0|[1-9]\d*)$/,oe=parseInt,re=Object.prototype,F=re.toString,se=Math.ceil,ie=Math.max;function ae(e,t,n){var o=-1,r=e.length;t<0&&(t=-t>r?0:r+t),n=n>r?r:n,n<0&&(n+=r),r=t>n?0:n-t>>>0,t>>>=0;for(var i=Array(r);++o<r;)i[o]=e[o+t];return i}function de(e,t){return t=t??k,!!t&&(typeof e=="number"||ne.test(e))&&e>-1&&e%1==0&&e<t}function ce(e,t,n){if(!y(n))return!1;var o=typeof t;return(o=="number"?le(n)&&de(t,n.length):o=="string"&&t in n)?fe(n[t],e):!1}function ue(e,t,n){(n?ce(e,t,n):t===void 0)?t=1:t=ie(he(t),0);var o=e?e.length:0;if(!o||t<1)return[];for(var r=0,i=0,s=Array(se(o/t));r<o;)s[i++]=ae(e,r,r+=t);return s}function fe(e,t){return e===t||e!==e&&t!==t}function le(e){return e!=null&&pe(e.length)&&!me(e)}function me(e){var t=y(e)?F.call(e):"";return t==J||t==K}function pe(e){return typeof e=="number"&&e>-1&&e%1==0&&e<=k}function y(e){var t=typeof e;return!!e&&(t=="object"||t=="function")}function ye(e){return!!e&&typeof e=="object"}function ge(e){return typeof e=="symbol"||ye(e)&&F.call(e)==V}function Ie(e){if(!e)return e===0?e:0;if(e=Ne(e),e===b||e===-b){var t=e<0?-1:1;return t*Y}return e===e?e:0}function he(e){var t=Ie(e),n=t%1;return t===t?n?t-n:t:0}function Ne(e){if(typeof e=="number")return e;if(ge(e))return A;if(y(e)){var t=typeof e.valueOf=="function"?e.valueOf():e;e=y(t)?t+"":t}if(typeof e!="string")return e===0?e:+e;e=e.replace(Z,"");var n=ee.test(e);return n||te.test(e)?oe(e.slice(2),n?2:8):z.test(e)?A:+e}var be=ue;async function ke(e,t){await Ae(e,t),await Fe(e,t)}async function Ae({id:e},t){(await f.get(`issues/${e}/sprints?fields=name,id,agile(name,id),goal`)).data.forEach(r=>{t.addNode("sprint",r),t.addRelation({fromNode:"issue",from:e,toNode:"sprint",to:r.id,type:"in"}),r.agile&&(t.addNode("board",r.agile),t.addRelation({fromNode:"issue",from:e,toNode:"board",to:r.agile.id,type:"in"}),t.addRelation({fromNode:"sprint",from:r.id,toNode:"board",to:r.agile.id,type:"in"}))})}async function Fe({id:e},t){(await f.get(`issues/${e}/comments?${D}`)).data.forEach(r=>{t.addNode("comment",r),t.addRelation({fromNode:"issue",from:e,toNode:"comment",to:r.id,type:"in"})})}async function we(e){const t=e.getIssues(),n=be(t,50);for await(const o of n){const r=o.map(i=>ke(i,e));await Promise.all(r)}}async function Re({query:e,maxDepthLevel:t}){const n=H(),o=await f.get(`issues?${h}&query=${encodeURI(e)}`);return o.data.forEach(r=>n.addIssue(r)),await j({ids:I({issues:o.data,addRelation:n.addIssueRelation}),isAlreadyLoaded:n.isAlreadyLoaded,onLoadedIssue:n.addIssue,addRelation:n.addIssueRelation,maxDepthLevel:t}),await we(n),{issues:n.getIssues(),relations:n.getRelations(),nodes:n.getNodes()}}async function Ue(e){return Re(e)}async function $e({addNodes:e,addRelations:t,config:n}){f.defaults.baseURL=n.url,f.defaults.headers.Authorization=`Bearer ${n.token}`;for await(const o of n.issueQueries){const{issues:r,relations:i,nodes:s}=await Ue({query:o,maxDepthLevel:n.issueLoadingMaxDepthLevel});await e("issue",r);for await(const[a,c]of s)await e(a,c);await t(i)}}const Le={name:"youtrack-connector",connect:$e};u.LinkTypeName=p,u.default=Le,Object.defineProperties(u,{__esModule:{value:!0},[Symbol.toStringTag]:{value:"Module"}})});
