(function(y,j){typeof exports=="object"&&typeof module<"u"?module.exports=j(require("axios")):typeof define=="function"&&define.amd?define(["axios"],j):(y=typeof globalThis<"u"?globalThis:y||self,y["coya-youtrack-connector"]=j(y.axios))})(this,function(y){"use strict";const F=(e=>e&&typeof e=="object"&&"default"in e?e:{default:e})(y);function C(e){return e}var S=b;b.flatten=b,b.unflatten=w;function g(e){return e&&e.constructor&&typeof e.constructor.isBuffer=="function"&&e.constructor.isBuffer(e)}function v(e){return e}function b(e,t){t=t||{};const n=t.delimiter||".",o=t.maxDepth,d=t.transformKey||v,s={};function a(c,m,p){p=p||1,Object.keys(c).forEach(function(u){const i=c[u],r=t.safe&&Array.isArray(i),f=Object.prototype.toString.call(i),l=g(i),x=f==="[object Object]"||f==="[object Array]",h=m?m+n+d(u):d(u);if(!r&&!l&&x&&Object.keys(i).length&&(!t.maxDepth||p<o))return a(i,h,p+1);s[h]=i})}return a(e),s}function w(e,t){t=t||{};const n=t.delimiter||".",o=t.overwrite||!1,d=t.transformKey||v,s={};if(g(e)||Object.prototype.toString.call(e)!=="[object Object]")return e;function c(u){const i=Number(u);return isNaN(i)||u.indexOf(".")!==-1||t.object?u:i}function m(u,i,r){return Object.keys(r).reduce(function(f,l){return f[u+n+l]=r[l],f},i)}function p(u){const i=Object.prototype.toString.call(u),r=i==="[object Array]",f=i==="[object Object]";if(u){if(r)return!u.length;if(f)return!Object.keys(u).length}else return!0}return e=Object.keys(e).reduce(function(u,i){const r=Object.prototype.toString.call(e[i]);return!(r==="[object Object]"||r==="[object Array]")||p(e[i])?(u[i]=e[i],u):m(i,u,b(e[i],t))},{}),Object.keys(e).forEach(function(u){const i=u.split(n).map(d);let r=c(i.shift()),f=c(i[0]),l=s;for(;f!==void 0;){if(r==="__proto__")return;const x=Object.prototype.toString.call(l[r]),h=x==="[object Object]"||x==="[object Array]";if(!o&&!h&&typeof l[r]<"u")return;(o&&!h||!o&&l[r]==null)&&(l[r]=typeof f=="number"&&!t.object?[]:{}),l=l[r],i.length>0&&(r=c(i.shift()),f=c(i[0]))}l[r]=w(e[u],t)}),s}const I=F.default.create({baseURL:"https://socialtech.myjetbrains.com/api/",headers:{Authorization:"Bearer perm:YWxla3NhbmRyLm15a3VseWNo.NjEtMzY=.3YAXZtLSVD7SLVpr9C4MfcIQXDkjFM"}});var O=(e=>(e.Subtask="Subtask",e.Duplicate="Duplicate",e.Depend="Depend",e.Relates="Relates",e))(O||{});function k({issues:e,isAlreadyLoaded:t,addRelation:n}){const o=t!=null?t:s=>!1;return e.flatMap(s=>{const a=D(s);return a&&a.length>0?(a.forEach(c=>n({from:s.id,to:c,type:O.Subtask})),a.filter(c=>!o(c))):[]})}function D(e){return e.links.filter(t=>t.linkType.name===O.Subtask&&t.direction==="OUTWARD").flatMap(t=>t.issues).map(t=>t.id)}const A="fields=id,idReadable,summary,description,reporter(login),links(id,direction,linkType(name),issues(id)),tags(name),customFields($type,name,value($type,archived,avatarUrl,buildIntegration,buildLink,color(background,id),description,fullName,id,isResolved,localizedName,login,markdownText,minutes,name,presentation,ringId,text))";async function L(e){let t=e.ids;const{maxDepthLevel:n}=e;let o=0;for(;t.length>0&&(!n||o++<n);)t=await N({...e,ids:t})}async function N({ids:e,onLoadedIssue:t,isAlreadyLoaded:n,addRelation:o}){const s=(await I.post(`issuesGetter?${A}`,e.map(a=>({id:a})))).data;return s.forEach(a=>t(a)),k({issues:s,isAlreadyLoaded:n,addRelation:o})}function E(e){M(e),_(e)}function M({issue:e,addNode:t,addRelation:n}){var o;(o=e.tags)==null||o.forEach(d=>{t("tag",{id:d.name,...d}),n({toNode:"tag",to:d.name,fromNode:"issue",from:e.id,type:"tag"})})}function _({issue:e,addNode:t,addRelation:n}){var d;const o=(d=e.customFields)==null?void 0:d.find(s=>s.name==="Sprint");o&&Array.isArray(o.value)&&o.value.forEach(s=>{t("sprint",{id:s.id,name:s.name}),n({toNode:"sprint",to:s.id,fromNode:"issue",from:e.id,type:"sprint"})})}function B(e){var t,n,o,d,s,a,c,m,p,u,i;return{storyPoints:(n=(t=e.customFields)==null?void 0:t.find(r=>r.name==="Story points"))==null?void 0:n.value,state:(s=(d=(o=e.customFields)==null?void 0:o.find(r=>r.name==="State"))==null?void 0:d.value)==null?void 0:s.name,source:(m=(c=(a=e.customFields)==null?void 0:a.find(r=>r.name==="Source"))==null?void 0:c.value)==null?void 0:m.name,priority:(i=(u=(p=e.customFields)==null?void 0:p.find(r=>r.name==="Priority"))==null?void 0:u.value)==null?void 0:i.name}}function K(){const e=new Map,t=new Map,n=[],o=s=>n.push(s),d=(s,a)=>{t.has(s)||t.set(s,new Map);const c=t.get(s);c&&!c.has(a.id)&&c.set(a.id,a)};return{addNode:d,addRelation:o,isAlreadyLoaded(s){return e.has(s)},addIssue(s){if(!e.has(s.id)){const a={...s,links:void 0,tags:void 0,customFields:void 0,...B(s)};e.set(s.id,a),E({issue:s,addNode:d,addRelation:o})}},addIssueRelation({from:s,to:a,type:c}){return o({fromNode:"issue",from:s,toNode:"issue",to:a,type:c})},getIssues(){return R(e)},getRelations(){return n},getNodes(){return $(t)}}}function $(e){return Array.from(e).map(([t,n])=>[t,R(n)])}function R(e){return Array.from(e,([t,n])=>n)}async function T({query:e,maxDepthLevel:t}){const n=K(),o=await I.get(`issues?${A}&query=${encodeURI(e)}`);return o.data.forEach(d=>n.addIssue(d)),await L({ids:k({issues:o.data,addRelation:n.addIssueRelation}),isAlreadyLoaded:n.isAlreadyLoaded,onLoadedIssue:n.addIssue,addRelation:n.addIssueRelation,maxDepthLevel:t}),{issues:n.getIssues(),relations:n.getRelations(),nodes:n.getNodes()}}async function U(e){return T(e)}async function z({addNodes:e,addRelations:t,config:n}){I.defaults.baseURL=n.url,I.defaults.headers.Authorization=`Bearer ${n.token}`;for await(const o of n.issueQueries){const{issues:d,relations:s,nodes:a}=await U({query:o,maxDepthLevel:n.issueLoadingMaxDepthLevel});await e("issue",d.map(c=>S.flatten(c)));for await(const[c,m]of a)await e(c,m);await t(s)}}return{name:"youtrack-connector",connect:z}});
