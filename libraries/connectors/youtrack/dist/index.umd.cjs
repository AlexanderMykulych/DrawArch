(function(p,h){typeof exports=="object"&&typeof module<"u"?module.exports=h(require("axios")):typeof define=="function"&&define.amd?define(["axios"],h):(p=typeof globalThis<"u"?globalThis:p||self,p["coya-youtrack-connector"]=h(p.axios))})(this,function(p){"use strict";const D=(e=>e&&typeof e=="object"&&"default"in e?e:{default:e})(p);function M(e){return e}var R=b;b.flatten=b,b.unflatten=x;function w(e){return e&&e.constructor&&typeof e.constructor.isBuffer=="function"&&e.constructor.isBuffer(e)}function I(e){return e}function b(e,t){t=t||{};const u=t.delimiter||".",a=t.maxDepth,f=t.transformKey||I,s={};function c(o,j,y){y=y||1,Object.keys(o).forEach(function(i){const n=o[i],r=t.safe&&Array.isArray(n),l=Object.prototype.toString.call(n),d=w(n),k=l==="[object Object]"||l==="[object Array]",m=j?j+u+f(i):f(i);if(!r&&!d&&k&&Object.keys(n).length&&(!t.maxDepth||y<a))return c(n,m,y+1);s[m]=n})}return c(e),s}function x(e,t){t=t||{};const u=t.delimiter||".",a=t.overwrite||!1,f=t.transformKey||I,s={};if(w(e)||Object.prototype.toString.call(e)!=="[object Object]")return e;function o(i){const n=Number(i);return isNaN(n)||i.indexOf(".")!==-1||t.object?i:n}function j(i,n,r){return Object.keys(r).reduce(function(l,d){return l[i+u+d]=r[d],l},n)}function y(i){const n=Object.prototype.toString.call(i),r=n==="[object Array]",l=n==="[object Object]";if(i){if(r)return!i.length;if(l)return!Object.keys(i).length}else return!0}return e=Object.keys(e).reduce(function(i,n){const r=Object.prototype.toString.call(e[n]);return!(r==="[object Object]"||r==="[object Array]")||y(e[n])?(i[n]=e[n],i):j(n,i,b(e[n],t))},{}),Object.keys(e).forEach(function(i){const n=i.split(u).map(f);let r=o(n.shift()),l=o(n[0]),d=s;for(;l!==void 0;){if(r==="__proto__")return;const k=Object.prototype.toString.call(d[r]),m=k==="[object Object]"||k==="[object Array]";if(!a&&!m&&typeof d[r]<"u")return;(a&&!m||!a&&d[r]==null)&&(d[r]=typeof l=="number"&&!t.object?[]:{}),d=d[r],n.length>0&&(r=o(n.shift()),l=o(n[0]))}d[r]=x(e[i],t)}),s}const O=D.default.create({baseURL:"https://socialtech.myjetbrains.com/api/",headers:{Authorization:"Bearer perm:YWxla3NhbmRyLm15a3VseWNo.NjEtMzY=.3YAXZtLSVD7SLVpr9C4MfcIQXDkjFM"}});var A=(e=>(e.Subtask="Subtask",e.Duplicate="Duplicate",e.Depend="Depend",e.Relates="Relates",e))(A||{});const S="fields=id,idReadable,summary,description,reporter(login),links(id,direction,linkType(name),issues(id))";async function E(){const e=new Map,t=[],u=await O.get(`issues?${S}&query=tag:frontend&$top=400`),a=s=>{if(!e.has(s.id)){const c={...s,links:void 0};e.set(s.id,c)}},f=(s,c)=>t.push({fromNode:"issue",from:s,toNode:"issue",to:c});return u.data.forEach(s=>a(s)),await K({ids:_({issues:u.data,addRelation:f}),isLoaded:s=>e.has(s),addIssue:a,addRelation:f}),{issues:Array.from(e,([s,c])=>c),relations:t}}async function K({ids:e,addIssue:t,isLoaded:u,addRelation:a}){let f=e;const s=async()=>{const o=(await O.post(`issuesGetter?${S}`,f.map(y=>({id:y})))).data;o.forEach(y=>t(y)),f=_({issues:o,isLoaded:u,addRelation:a})};for(;f.length>0;)await s()}function _({issues:e,isLoaded:t,addRelation:u}){const a=t!=null?t:s=>!1;return e.flatMap(s=>{const c=s.links.filter(o=>o.linkType.name===A.Subtask).flatMap(o=>o.issues);return c&&c.length>0?(c.forEach(({id:o})=>u(s.id,o)),c.filter(o=>!a(o.id)).map(o=>o.id)):[]})}async function g({addNodes:e,addRelations:t,config:u}){O.defaults.baseURL=u.url,O.defaults.headers.Authorization=`Bearer ${u.token}`;const{issues:a,relations:f}=await E();await e("issue",a.map(s=>R.flatten(s))),await t(f)}return{name:"youtrack-connector",connect:g}});
