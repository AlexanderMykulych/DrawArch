(function(b,j){typeof exports=="object"&&typeof module<"u"?module.exports=j(require("axios")):typeof define=="function"&&define.amd?define(["axios"],j):(b=typeof globalThis<"u"?globalThis:b||self,b["coya-youtrack-connector"]=j(b.axios))})(this,function(b){"use strict";const E=(e=>e&&typeof e=="object"&&"default"in e?e:{default:e})(b);function v(e){return e}var M=m;m.flatten=m,m.unflatten=x;function k(e){return e&&e.constructor&&typeof e.constructor.isBuffer=="function"&&e.constructor.isBuffer(e)}function A(e){return e}function m(e,t){t=t||{};const r=t.delimiter||".",u=t.maxDepth,c=t.transformKey||A,f={};function d(o,p,i){i=i||1,Object.keys(o).forEach(function(s){const n=o[s],a=t.safe&&Array.isArray(n),l=Object.prototype.toString.call(n),y=k(n),w=l==="[object Object]"||l==="[object Array]",h=p?p+r+c(s):c(s);if(!a&&!y&&w&&Object.keys(n).length&&(!t.maxDepth||i<u))return d(n,h,i+1);f[h]=n})}return d(e),f}function x(e,t){t=t||{};const r=t.delimiter||".",u=t.overwrite||!1,c=t.transformKey||A,f={};if(k(e)||Object.prototype.toString.call(e)!=="[object Object]")return e;function o(s){const n=Number(s);return isNaN(n)||s.indexOf(".")!==-1||t.object?s:n}function p(s,n,a){return Object.keys(a).reduce(function(l,y){return l[s+r+y]=a[y],l},n)}function i(s){const n=Object.prototype.toString.call(s),a=n==="[object Array]",l=n==="[object Object]";if(s){if(a)return!s.length;if(l)return!Object.keys(s).length}else return!0}return e=Object.keys(e).reduce(function(s,n){const a=Object.prototype.toString.call(e[n]);return!(a==="[object Object]"||a==="[object Array]")||i(e[n])?(s[n]=e[n],s):p(n,s,m(e[n],t))},{}),Object.keys(e).forEach(function(s){const n=s.split(r).map(c);let a=o(n.shift()),l=o(n[0]),y=f;for(;l!==void 0;){if(a==="__proto__")return;const w=Object.prototype.toString.call(y[a]),h=w==="[object Object]"||w==="[object Array]";if(!u&&!h&&typeof y[a]<"u")return;(u&&!h||!u&&y[a]==null)&&(y[a]=typeof l=="number"&&!t.object?[]:{}),y=y[a],n.length>0&&(a=o(n.shift()),l=o(n[0]))}y[a]=x(e[s],t)}),f}const O=E.default.create({baseURL:"https://socialtech.myjetbrains.com/api/",headers:{Authorization:"Bearer perm:YWxla3NhbmRyLm15a3VseWNo.NjEtMzY=.3YAXZtLSVD7SLVpr9C4MfcIQXDkjFM"}});function g(e,t,r){var u;(u=e.tags)==null||u.forEach(c=>{t("tag",{id:c.name,...c}),r({toNode:"tag",to:c.name,fromNode:"issue",from:e.id})})}var I=(e=>(e.Subtask="Subtask",e.Duplicate="Duplicate",e.Depend="Depend",e.Relates="Relates",e))(I||{});function R({issues:e,isLoaded:t,addRelation:r}){const u=t!=null?t:f=>!1;return e.flatMap(f=>{const d=f.links.filter(o=>o.linkType.name===I.Subtask).flatMap(o=>o.issues);return d&&d.length>0?(d.forEach(({id:o})=>r({from:f.id,to:o,type:I.Subtask})),d.filter(o=>!u(o.id)).map(o=>o.id)):[]})}const S="fields=id,idReadable,summary,description,reporter(login),links(id,direction,linkType(name),issues(id)),tags(name)";async function D({ids:e,addIssue:t,isLoaded:r,addRelation:u}){let c=e;const f=async()=>{const o=(await O.post(`issuesGetter?${S}`,c.map(i=>({id:i})))).data;o.forEach(i=>t(i)),c=R({issues:o,isLoaded:r,addRelation:u})};for(;c.length>0;)await f()}async function K({query:e}){const t=new Map,r=new Map,u=[],c=await O.get(`issues?${S}&query=${encodeURI(e)}`),f=(i,s)=>{r.has(i)||r.set(i,new Map);const n=r.get(i);n&&!n.has(s.id)&&n.set(s.id,s)},d=i=>u.push(i),o=i=>{if(!t.has(i.id)){const s={...i,links:void 0,tags:void 0};t.set(i.id,s),g(i,f,d)}},p=({from:i,to:s,type:n})=>d({fromNode:"issue",from:i,toNode:"issue",to:s,type:n});return c.data.forEach(i=>o(i)),await D({ids:R({issues:c.data,addRelation:p}),isLoaded:i=>t.has(i),addIssue:o,addRelation:p}),{issues:_(t),relations:u,nodes:N(r)}}function _(e){return Array.from(e,([t,r])=>r)}function N(e){return Array.from(e).map(([t,r])=>[t,_(r)])}async function B({addNodes:e,addRelations:t,config:r}){O.defaults.baseURL=r.url,O.defaults.headers.Authorization=`Bearer ${r.token}`;for await(const u of r.issueQueries){const{issues:c,relations:f,nodes:d}=await K({query:u});await e("issue",c.map(o=>M.flatten(o)));for await(const[o,p]of d)await e(o,p);await t(f)}}return{name:"youtrack-connector",connect:B}});
