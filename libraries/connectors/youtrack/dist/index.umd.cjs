(function(v,g){typeof exports=="object"&&typeof module<"u"?module.exports=g(require("axios")):typeof define=="function"&&define.amd?define(["axios"],g):(v=typeof globalThis<"u"?globalThis:v||self,v["coya-youtrack-connector"]=g(v.axios))})(this,function(v){"use strict";const R=(e=>e&&typeof e=="object"&&"default"in e?e:{default:e})(v);function H(e){return e}var S=j;j.flatten=j,j.unflatten=x;function A(e){return e&&e.constructor&&typeof e.constructor.isBuffer=="function"&&e.constructor.isBuffer(e)}function k(e){return e}function j(e,t){t=t||{};const o=t.delimiter||".",n=t.maxDepth,i=t.transformKey||k,r={};function s(c,l,p){p=p||1,Object.keys(c).forEach(function(d){const a=c[d],u=t.safe&&Array.isArray(a),f=Object.prototype.toString.call(a),m=A(a),h=f==="[object Object]"||f==="[object Array]",b=l?l+o+i(d):i(d);if(!u&&!m&&h&&Object.keys(a).length&&(!t.maxDepth||p<n))return s(a,b,p+1);r[b]=a})}return s(e),r}function x(e,t){t=t||{};const o=t.delimiter||".",n=t.overwrite||!1,i=t.transformKey||k,r={};if(A(e)||Object.prototype.toString.call(e)!=="[object Object]")return e;function c(d){const a=Number(d);return isNaN(a)||d.indexOf(".")!==-1||t.object?d:a}function l(d,a,u){return Object.keys(u).reduce(function(f,m){return f[d+o+m]=u[m],f},a)}function p(d){const a=Object.prototype.toString.call(d),u=a==="[object Array]",f=a==="[object Object]";if(d){if(u)return!d.length;if(f)return!Object.keys(d).length}else return!0}return e=Object.keys(e).reduce(function(d,a){const u=Object.prototype.toString.call(e[a]);return!(u==="[object Object]"||u==="[object Array]")||p(e[a])?(d[a]=e[a],d):l(a,d,j(e[a],t))},{}),Object.keys(e).forEach(function(d){const a=d.split(o).map(i);let u=c(a.shift()),f=c(a[0]),m=r;for(;f!==void 0;){if(u==="__proto__")return;const h=Object.prototype.toString.call(m[u]),b=h==="[object Object]"||h==="[object Array]";if(!n&&!b&&typeof m[u]<"u")return;(n&&!b||!n&&m[u]==null)&&(m[u]=typeof f=="number"&&!t.object?[]:{}),m=m[u],a.length>0&&(u=c(a.shift()),f=c(a[0]))}m[u]=x(e[d],t)}),r}const N=R.default.create({baseURL:"https://socialtech.myjetbrains.com/api/",headers:{Authorization:"Bearer perm:YWxla3NhbmRyLm15a3VseWNo.NjEtMzY=.3YAXZtLSVD7SLVpr9C4MfcIQXDkjFM"}});var I=(e=>(e.Subtask="Subtask",e.Duplicate="Duplicate",e.Depend="Depend",e.Relates="Relates",e))(I||{});function U({issues:e,isAlreadyLoaded:t,addRelation:o}){const n=t!=null?t:r=>!1;return e.flatMap(r=>{const s=L(r);return s&&s.length>0?(s.forEach(c=>o({from:r.id,to:c,type:I.Subtask})),s.filter(c=>!n(c))):[]})}function L(e){return e.links.filter(t=>t.linkType.name===I.Subtask&&t.direction==="OUTWARD").flatMap(t=>t.issues).map(t=>t.id)}const D="customFields($type,name,value($type,archived,avatarUrl,buildIntegration,buildLink,color(background,id),description,fullName,id,isResolved,localizedName,login,markdownText,minutes,name,presentation,ringId,text))",F="id,login,name,fullName,avatarUrl",E=`reporter(${F})`,M=`updater(${F})`,O=`fields=id,idReadable,summary,description,updated,created,usesMarkdown,${E},${M},links(id,direction,linkType(name),issues(id)),tags(name),${D}`;async function _(e){let t=e.ids;const{maxDepthLevel:o}=e;let n=0;for(;t.length>0&&(!o||n++<o);)t=await $({...e,ids:t})}async function $({ids:e,onLoadedIssue:t,isAlreadyLoaded:o,addRelation:n}){const r=(await N.post(`issuesGetter?${O}`,e.map(s=>({id:s})))).data;return r.forEach(s=>t(s)),U({issues:r,isAlreadyLoaded:o,addRelation:n})}function B(e){K(e),Q(e),T(e),q(e),z(e),C(e),G(e)}function K({issue:e,addNode:t,addRelation:o}){var n;(n=e.tags)==null||n.forEach(i=>{t("tag",{id:i.name,...i}),o({toNode:"tag",to:i.name,fromNode:"issue",from:e.id,type:"tag"})})}function Q({issue:e,addNode:t,addRelation:o}){var i;const n=(i=e.customFields)==null?void 0:i.find(r=>r.name==="Sprint");n&&Array.isArray(n.value)&&n.value.forEach(r=>{t("sprint",{id:r.id,name:r.name}),o({toNode:"sprint",to:r.id,fromNode:"issue",from:e.id,type:"sprint"})})}function T({issue:e,addNode:t,addRelation:o}){var r,s;const n=(s=(r=e.customFields)==null?void 0:r.find(c=>c.name==="GitLab PR link"))==null?void 0:s.value,i=n==null?void 0:n.matchAll(/merge_requests\/(?<mrNumber>\d*)/gm);i&&Array.from(i).map(l=>{var p;return((p=l.groups)==null?void 0:p.mrNumber)||""}).forEach(l=>{t("mr",{id:l,number:l}),o({toNode:"mr",to:l,fromNode:"issue",from:e.id,type:"mr"})})}function q({issue:e,addNode:t,addRelation:o}){var i,r;const n=(r=(i=e.customFields)==null?void 0:i.find(s=>s.name==="Assignee"))==null?void 0:r.value;n&&Array.isArray(n)&&n.forEach(s=>{t("trackerUser",{id:s.id,name:s.name,fullName:s.fullName,login:s.login,avatarUrl:s.avatarUrl}),o({fromNode:"issue",from:e.id,toNode:"trackerUser",to:s.id,type:"assignee"})})}function z({issue:e,addNode:t,addRelation:o}){var i,r;const n=(r=(i=e.customFields)==null?void 0:i.find(s=>s.name==="Assignee QA"))==null?void 0:r.value;n&&Array.isArray(n)&&n.forEach(s=>{t("trackerUser",{id:s.id,name:s.name,fullName:s.fullName,login:s.login,avatarUrl:s.avatarUrl}),o({fromNode:"issue",from:e.id,toNode:"trackerUser",to:s.id,type:"assigneeQA"})})}function C({issue:e,addNode:t,addRelation:o}){const n=e.reporter;n&&n.id&&(t("trackerUser",{id:n.id,name:n.name,fullName:n.fullName,login:n.login,avatarUrl:n.avatarUrl}),o({fromNode:"issue",from:e.id,toNode:"trackerUser",to:n.id,type:"reporter"}))}function G({issue:e,addNode:t,addRelation:o}){const n=e.updater;n&&n.id&&(t("trackerUser",{id:n.id,name:n.name,fullName:n.fullName,login:n.login,avatarUrl:n.avatarUrl}),o({fromNode:"issue",from:e.id,toNode:"trackerUser",to:n.id,type:"updater"}))}function P(e){var t,o,n,i,r,s,c,l,p,d,a,u,f,m,h,b;return{storyPoints:(o=(t=e.customFields)==null?void 0:t.find(y=>y.name==="Story points"))==null?void 0:o.value,state:(r=(i=(n=e.customFields)==null?void 0:n.find(y=>y.name==="State"))==null?void 0:i.value)==null?void 0:r.name,source:(l=(c=(s=e.customFields)==null?void 0:s.find(y=>y.name==="Source"))==null?void 0:c.value)==null?void 0:l.name,priority:(a=(d=(p=e.customFields)==null?void 0:p.find(y=>y.name==="Priority"))==null?void 0:d.value)==null?void 0:a.name,severity:(m=(f=(u=e.customFields)==null?void 0:u.find(y=>y.name==="Severity"))==null?void 0:f.value)==null?void 0:m.name,tags:(b=(h=e.tags)==null?void 0:h.map(y=>y.name))==null?void 0:b.join(",")}}function W(){const e=new Map,t=new Map,o=[],n=r=>o.push(r),i=(r,s)=>{t.has(r)||t.set(r,new Map);const c=t.get(r);c&&!c.has(s.id)&&c.set(s.id,s)};return{addNode:i,addRelation:n,isAlreadyLoaded(r){return e.has(r)},addIssue(r){if(!e.has(r.id)){const s={...r,links:void 0,tags:void 0,customFields:void 0,...P(r)};e.set(r.id,s),B({issue:r,addNode:i,addRelation:n})}},addIssueRelation({from:r,to:s,type:c}){return n({fromNode:"issue",from:r,toNode:"issue",to:s,type:c})},getIssues(){return w(e)},getRelations(){return o},getNodes(){return Y(t)}}}function Y(e){return Array.from(e).map(([t,o])=>[t,w(o)])}function w(e){return Array.from(e,([t,o])=>o)}async function X({query:e,maxDepthLevel:t}){const o=W(),n=await N.get(`issues?${O}&query=${encodeURI(e)}`);return n.data.forEach(i=>o.addIssue(i)),await _({ids:U({issues:n.data,addRelation:o.addIssueRelation}),isAlreadyLoaded:o.isAlreadyLoaded,onLoadedIssue:o.addIssue,addRelation:o.addIssueRelation,maxDepthLevel:t}),{issues:o.getIssues(),relations:o.getRelations(),nodes:o.getNodes()}}async function V(e){return X(e)}async function Z({addNodes:e,addRelations:t,config:o}){N.defaults.baseURL=o.url,N.defaults.headers.Authorization=`Bearer ${o.token}`;for await(const n of o.issueQueries){const{issues:i,relations:r,nodes:s}=await V({query:n,maxDepthLevel:o.issueLoadingMaxDepthLevel});await e("issue",i.map(c=>S.flatten(c)));for await(const[c,l]of s)await e(c,l);await t(r)}}return{name:"youtrack-connector",connect:Z}});
