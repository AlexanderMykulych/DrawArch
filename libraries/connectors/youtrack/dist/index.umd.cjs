(function(v,j){typeof exports=="object"&&typeof module<"u"?module.exports=j(require("axios")):typeof define=="function"&&define.amd?define(["axios"],j):(v=typeof globalThis<"u"?globalThis:v||self,v["coya-youtrack-connector"]=j(v.axios))})(this,function(v){"use strict";function j(e){return e}var R=A;A.flatten=A,A.unflatten=x;function g(e){return e&&e.constructor&&typeof e.constructor.isBuffer=="function"&&e.constructor.isBuffer(e)}function k(e){return e}function A(e,n){n=n||{};const r=n.delimiter||".",t=n.maxDepth,s=n.transformKey||k,o={};function i(c,l,y){y=y||1,Object.keys(c).forEach(function(d){const a=c[d],u=n.safe&&Array.isArray(a),f=Object.prototype.toString.call(a),m=g(a),h=f==="[object Object]"||f==="[object Array]",b=l?l+r+s(d):s(d);if(!u&&!m&&h&&Object.keys(a).length&&(!n.maxDepth||y<t))return i(a,b,y+1);o[b]=a})}return i(e),o}function x(e,n){n=n||{};const r=n.delimiter||".",t=n.overwrite||!1,s=n.transformKey||k,o={};if(g(e)||Object.prototype.toString.call(e)!=="[object Object]")return e;function c(d){const a=Number(d);return isNaN(a)||d.indexOf(".")!==-1||n.object?d:a}function l(d,a,u){return Object.keys(u).reduce(function(f,m){return f[d+r+m]=u[m],f},a)}function y(d){const a=Object.prototype.toString.call(d),u=a==="[object Array]",f=a==="[object Object]";if(d){if(u)return!d.length;if(f)return!Object.keys(d).length}else return!0}return e=Object.keys(e).reduce(function(d,a){const u=Object.prototype.toString.call(e[a]);return!(u==="[object Object]"||u==="[object Array]")||y(e[a])?(d[a]=e[a],d):l(a,d,A(e[a],n))},{}),Object.keys(e).forEach(function(d){const a=d.split(r).map(s);let u=c(a.shift()),f=c(a[0]),m=o;for(;f!==void 0;){if(u==="__proto__")return;const h=Object.prototype.toString.call(m[u]),b=h==="[object Object]"||h==="[object Array]";if(!t&&!b&&typeof m[u]<"u")return;(t&&!b||!t&&m[u]==null)&&(m[u]=typeof f=="number"&&!n.object?[]:{}),m=m[u],a.length>0&&(u=c(a.shift()),f=c(a[0]))}m[u]=x(e[d],n)}),o}const I=v.create({baseURL:"https://socialtech.myjetbrains.com/api/",headers:{Authorization:"Bearer <token>"}});var N=(e=>(e.Subtask="Subtask",e.Duplicate="Duplicate",e.Depend="Depend",e.Relates="Relates",e))(N||{});function U({issues:e,isAlreadyLoaded:n,addRelation:r}){const t=n??(o=>!1);return e.flatMap(o=>{const i=L(o);return i&&i.length>0?(i.forEach(c=>r({from:o.id,to:c,type:N.Subtask})),i.filter(c=>!t(c))):[]})}function L(e){return e.links.filter(n=>n.linkType.name===N.Subtask&&n.direction==="OUTWARD").flatMap(n=>n.issues).map(n=>n.id)}const S="customFields($type,name,value($type,archived,avatarUrl,buildIntegration,buildLink,color(background,id),description,fullName,id,isResolved,localizedName,login,markdownText,minutes,name,presentation,ringId,text))",O="id,login,name,fullName,avatarUrl,email",E=`reporter(${O})`,$=`updater(${O})`,F=`fields=id,idReadable,summary,description,updated,created,usesMarkdown,${E},${$},links(id,direction,linkType(name),issues(id)),tags(name),${S}`;async function D(e){let n=e.ids;const{maxDepthLevel:r}=e;let t=0;for(;n.length>0&&(!r||t++<r);)n=await M({...e,ids:n})}async function M({ids:e,onLoadedIssue:n,isAlreadyLoaded:r,addRelation:t}){const o=(await I.post(`issuesGetter?${F}`,e.map(i=>({id:i})))).data;return o.forEach(i=>n(i)),U({issues:o,isAlreadyLoaded:r,addRelation:t})}function B(e){K(e),_(e),T(e),Q(e),q(e),z(e),C(e)}function K({issue:e,addNode:n,addRelation:r}){var t;(t=e.tags)==null||t.forEach(s=>{n("tag",{id:s.name,...s}),r({toNode:"tag",to:s.name,fromNode:"issue",from:e.id,type:"tag"})})}function _({issue:e,addNode:n,addRelation:r}){var s;const t=(s=e.customFields)==null?void 0:s.find(o=>o.name==="Sprint");t&&Array.isArray(t.value)&&t.value.forEach(o=>{n("sprint",{id:o.id,name:o.name}),r({toNode:"sprint",to:o.id,fromNode:"issue",from:e.id,type:"sprint"})})}function T({issue:e,addNode:n,addRelation:r}){var o,i;const t=(i=(o=e.customFields)==null?void 0:o.find(c=>c.name==="GitLab PR link"))==null?void 0:i.value,s=t==null?void 0:t.matchAll(/merge_requests\/(?<mrNumber>\d*)/gm);s&&Array.from(s).map(l=>{var y;return((y=l.groups)==null?void 0:y.mrNumber)||""}).forEach(l=>{n("mr",{id:l,number:l}),r({toNode:"mr",to:l,fromNode:"issue",from:e.id,type:"mr"})})}function Q({issue:e,addNode:n,addRelation:r}){var s,o;const t=(o=(s=e.customFields)==null?void 0:s.find(i=>i.name==="Assignee"))==null?void 0:o.value;t&&Array.isArray(t)&&t.forEach(i=>{n("trackerUser",{id:i.id,name:i.name,fullName:i.fullName,login:i.login,avatarUrl:i.avatarUrl,email:i.email}),r({fromNode:"issue",from:e.id,toNode:"trackerUser",to:i.id,type:"assignee"})})}function q({issue:e,addNode:n,addRelation:r}){var s,o;const t=(o=(s=e.customFields)==null?void 0:s.find(i=>i.name==="Assignee QA"))==null?void 0:o.value;t&&Array.isArray(t)&&t.forEach(i=>{n("trackerUser",{id:i.id,name:i.name,fullName:i.fullName,login:i.login,avatarUrl:i.avatarUrl,email:i.email}),r({fromNode:"issue",from:e.id,toNode:"trackerUser",to:i.id,type:"assigneeQA"})})}function z({issue:e,addNode:n,addRelation:r}){const t=e.reporter;t&&t.id&&(n("trackerUser",{id:t.id,name:t.name,fullName:t.fullName,login:t.login,avatarUrl:t.avatarUrl,email:t.email}),r({fromNode:"issue",from:e.id,toNode:"trackerUser",to:t.id,type:"reporter"}))}function C({issue:e,addNode:n,addRelation:r}){const t=e.updater;t&&t.id&&(n("trackerUser",{id:t.id,name:t.name,fullName:t.fullName,login:t.login,avatarUrl:t.avatarUrl,email:t.email}),r({fromNode:"issue",from:e.id,toNode:"trackerUser",to:t.id,type:"updater"}))}function G(e){var n,r,t,s,o,i,c,l,y,d,a,u,f,m,h,b;return{storyPoints:(r=(n=e.customFields)==null?void 0:n.find(p=>p.name==="Story points"))==null?void 0:r.value,state:(o=(s=(t=e.customFields)==null?void 0:t.find(p=>p.name==="State"))==null?void 0:s.value)==null?void 0:o.name,source:(l=(c=(i=e.customFields)==null?void 0:i.find(p=>p.name==="Source"))==null?void 0:c.value)==null?void 0:l.name,priority:(a=(d=(y=e.customFields)==null?void 0:y.find(p=>p.name==="Priority"))==null?void 0:d.value)==null?void 0:a.name,severity:(m=(f=(u=e.customFields)==null?void 0:u.find(p=>p.name==="Severity"))==null?void 0:f.value)==null?void 0:m.name,tags:(b=(h=e.tags)==null?void 0:h.map(p=>p.name))==null?void 0:b.join(",")}}function P(){const e=new Map,n=new Map,r=[],t=o=>r.push(o),s=(o,i)=>{n.has(o)||n.set(o,new Map);const c=n.get(o);c&&!c.has(i.id)&&c.set(i.id,i)};return{addNode:s,addRelation:t,isAlreadyLoaded(o){return e.has(o)},addIssue(o){if(!e.has(o.id)){const i={...o,links:void 0,tags:void 0,customFields:void 0,...G(o)};e.set(o.id,i),B({issue:o,addNode:s,addRelation:t})}},addIssueRelation({from:o,to:i,type:c}){return t({fromNode:"issue",from:o,toNode:"issue",to:i,type:c})},getIssues(){return w(e)},getRelations(){return r},getNodes(){return W(n)}}}function W(e){return Array.from(e).map(([n,r])=>[n,w(r)])}function w(e){return Array.from(e,([n,r])=>r)}async function H({query:e,maxDepthLevel:n}){const r=P(),t=await I.get(`issues?${F}&query=${encodeURI(e)}`);return t.data.forEach(s=>r.addIssue(s)),await D({ids:U({issues:t.data,addRelation:r.addIssueRelation}),isAlreadyLoaded:r.isAlreadyLoaded,onLoadedIssue:r.addIssue,addRelation:r.addIssueRelation,maxDepthLevel:n}),{issues:r.getIssues(),relations:r.getRelations(),nodes:r.getNodes()}}async function J(e){return H(e)}async function X({addNodes:e,addRelations:n,config:r}){I.defaults.baseURL=r.url,I.defaults.headers.Authorization=`Bearer ${r.token}`;for await(const t of r.issueQueries){const{issues:s,relations:o,nodes:i}=await J({query:t,maxDepthLevel:r.issueLoadingMaxDepthLevel});await e("issue",s.map(c=>R.flatten(c)));for await(const[c,l]of i)await e(c,l);await n(o)}}return{name:"youtrack-connector",connect:X}});
